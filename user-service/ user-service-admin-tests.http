### ============================================
### РАБОЧИЕ ТЕСТЫ АДМИНА (создаем пользователей через API)
### ============================================

@baseUrl = http://localhost:8083

### 1. Health Check
GET {{baseUrl}}/api/health

### 2. Создаем администратора через регистрацию
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "super.admin@example.com",
  "password": "Admin123!",
  "fullName": "Super Admin",
  "telephone": "+1-555-0001"
}

> {%
    if (response.status === 200) {
        if (response.body.accessToken) {
            client.global.set("super_admin_token", response.body.accessToken);
        } else if (response.body.token) {
            client.global.set("super_admin_token", response.body.token);
        }

        if (response.body.userId) {
            client.global.set("super_admin_id", response.body.userId.toString());
        } else if (response.body.id) {
            client.global.set("super_admin_id", response.body.id.toString());
        }

        console.log("Super Admin created. ID:", client.global.get("super_admin_id"));
        console.log("Token:", client.global.get("super_admin_token"));
    }
%}

### 3. Логин супер администратора
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "super.admin@example.com",
  "password": "Admin123!"
}

> {%
    if (response.status === 200) {
        if (response.body.accessToken) {
            client.global.set("super_admin_token", response.body.accessToken);
            client.global.set("super_admin_refresh", response.body.refreshToken || "");
        } else if (response.body.token) {
            client.global.set("super_admin_token", response.body.token);
            client.global.set("super_admin_refresh", response.body.refreshToken || "");
        }

        if (response.body.userId) {
            client.global.set("super_admin_id", response.body.userId.toString());
        }

        console.log("Super Admin logged in");
    }
%}

### 4. Получение профиля супер администратора
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{super_admin_token}}
X-User-Id: {{super_admin_id}}

### 5. Создаем менеджера
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "test.manager@example.com",
  "password": "Manager123!",
  "fullName": "Test Manager",
  "telephone": "+1-555-0002"
}

> {%
    if (response.status === 200) {
        if (response.body.userId) {
            client.global.set("manager_id", response.body.userId.toString());
        }
        console.log("Manager created. ID:", client.global.get("manager_id"));
    }
%}

### 6. Создаем обычного пользователя
##
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "test.user@example.com",
  "password": "User123!",
  "fullName": "Test User",
  "telephone": "+1-555-0003"
}

> {%
    if (response.status === 200) {
        if (response.body.userId) {
            client.global.set("user_id", response.body.userId.toString());
        }
        console.log("User created. ID:", client.global.get("user_id"));
    }
%}

### 7. Админ получает профиль менеджера
GET {{baseUrl}}/api/users/{{manager_id}}
Authorization: Bearer {{super_admin_token}}

### 8. Админ получает профиль пользователя
GET {{baseUrl}}/api/users/{{user_id}}
Authorization: Bearer {{super_admin_token}}

### 9. Логин менеджера
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "test.manager@example.com",
  "password": "Manager123!"
}

> {%
    if (response.status === 200) {
        if (response.body.accessToken) {
            client.global.set("manager_token", response.body.accessToken);
        } else if (response.body.token) {
            client.global.set("manager_token", response.body.token);
        }

        if (response.body.userId) {
            client.global.set("manager_id", response.body.userId.toString());
        }
        console.log("Manager logged in");
    }
%}

### 10. Менеджер получает свой профиль
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{manager_token}}
X-User-Id: {{manager_id}}

### 11. Менеджер пытается получить профиль админа (должен получить ошибку если нет прав)
GET {{baseUrl}}/api/users/{{super_admin_id}}
Authorization: Bearer {{manager_token}}

### 12. Логин обычного пользователя
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "test.user@example.com",
  "password": "User123!"
}

> {%
    if (response.status === 200) {
        if (response.body.accessToken) {
            client.global.set("user_token", response.body.accessToken);
        } else if (response.body.token) {
            client.global.set("user_token", response.body.token);
        }

        if (response.body.userId) {
            client.global.set("user_id", response.body.userId.toString());
        }
        console.log("User logged in");
    }
%}

### 13. Пользователь получает свой профиль
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{user_token}}
X-User-Id: {{user_id}}

### 14. Пользователь пытается получить профиль менеджера (должен получить ошибку)
GET {{baseUrl}}/api/users/{{manager_id}}
Authorization: Bearer {{user_token}}

### 15. Валидация токена админа
POST {{baseUrl}}/api/auth/validate
Authorization: Bearer {{super_admin_token}}

### 16. Выход админа
POST {{baseUrl}}/api/auth/logout
Authorization: Bearer {{super_admin_token}}

### 17. Попытка использовать токен после логаута
GET {{baseUrl}}/api/users/profile
Authorization: Bearer {{super_admin_token}}